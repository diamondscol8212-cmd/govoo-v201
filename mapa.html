<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GoVotto | MÉDULA DANTE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;600;900&family=JetBrains+Mono:wght@500;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #00ffcc; 
            --gold: #D4AF37;
            --bg: #000;
            --phi: 1.618;
        }

        body, html { 
            background: var(--bg); color: white; margin: 0; font-family: 'Outfit', sans-serif; 
            overflow: hidden; height: 100vh; width: 100vw; touch-action: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- 1. FONDO CUÁNTICO (DANTE GHOST) --- */
        #dante-fractal-bg { position: fixed; inset: 0; z-index: 0; opacity: 0.15; filter: blur(5px); pointer-events: none; }

        /* --- 2. HUD DE INTELIGENCIA --- */
        .master-hud {
            position: fixed; top: 0; width: 100%; z-index: 1000; padding: 35px 25px;
            background: linear-gradient(to bottom, rgba(0,0,0,1) 40%, transparent 100%);
            pointer-events: none;
        }

        /* --- 3. ESCENARIO DE LA HÉLICE (MOBILE FIRST) --- */
        .map-viewport {
            position: fixed; inset: 0; z-index: 10;
            perspective: 1500px; overflow-y: auto; overflow-x: hidden;
            scroll-behavior: smooth;
        }
        .map-viewport::-webkit-scrollbar { display: none; }

        .helix-scroll-area {
            position: relative; width: 100%; padding: 50vh 0 100vh;
            transform-style: preserve-3d;
        }

        /* --- 4. LA ARTERIA DE LUZ (SVG) --- */
        #neural-artery-svg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 5; pointer-events: none;
        }
        .artery-line { fill: none; stroke: var(--primary); stroke-width: 2; opacity: 0.15; stroke-linecap: round; }
        .artery-pulse { fill: none; stroke: var(--primary); stroke-width: 4; stroke-dasharray: 30, 200; animation: flowData 5s linear infinite; filter: drop-shadow(0 0 12px var(--primary)); }

        @keyframes flowData { 0% { stroke-dashoffset: 1000; } 100% { stroke-dashoffset: 0; } }

        /* --- 5. NODOS (CURVA DE ATAQUE) --- */
        .node-wrapper {
            position: relative; width: 100%; height: 200px;
            display: flex; justify-content: center; align-items: center;
            transform-style: preserve-3d; margin-bottom: 60px;
        }

        .quantum-node {
            position: relative; z-index: 20; width: 85px; height: 85px;
            background: #080808; border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; align-items: center; justify-content: center;
            transform: rotate(45deg); cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .node-rune { width: 40px; height: 40px; transform: rotate(-45deg); fill: none; stroke: currentColor; stroke-width: 2.5; }

        .node-wrapper.active .quantum-node { 
            border-color: var(--primary); color: var(--primary); scale: 1.25;
            box-shadow: 0 0 50px var(--primary);
            background: radial-gradient(circle, rgba(255,255,255,0.05), #000);
        }
        .node-wrapper.completed .quantum-node { border-color: var(--primary); color: var(--primary); opacity: 0.5; scale: 0.9; }
        .node-wrapper.locked { opacity: 0.1; filter: grayscale(1); pointer-events: none; }

        .node-label { 
            position: absolute; left: 130px; width: 150px; transform: rotate(-45deg); 
            font-family: 'JetBrains Mono'; font-size: 9px; color: var(--primary);
            text-transform: uppercase; letter-spacing: 0.2em; pointer-events: none;
            text-shadow: 0 0 10px #000;
        }

        /* --- 6. MENÚ TRÍADA (ANCLA DANTE) --- */
        .bottom-nav { 
            position: fixed; bottom: 35px; width: 92%; left: 4%; z-index: 1000;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(15,15,15,0.9); backdrop-filter: blur(25px);
            padding: 12px 30px; border-radius: 40px; border: 1px solid rgba(255,255,255,0.05);
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #444; transition: 0.3s; cursor: pointer; }
        .nav-item.active { color: var(--primary); filter: drop-shadow(0 0 5px var(--primary)); }

        #dante-anchor {
            width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--primary);
            background: #000; overflow: hidden; transform: translateY(-25px);
            box-shadow: 0 0 20px var(--primary); cursor: pointer;
        }

        /* PURIFICACIÓN CROMÁTICA - EFECTO DE LUZ PURA */
        #fx-flash { 
            position: fixed; inset: 0; z-index: 10001; 
            background: var(--primary); opacity: 1; pointer-events: none; 
            mix-blend-mode: screen; transition: opacity 1.5s ease-out; 
        }
    </style>
</head>
<body>

    <div id="fx-flash"></div>
    <canvas id="dante-fractal-bg"></canvas>

    <header class="master-hud">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-[8px] tracking-[0.5em] text-zinc-500 font-bold uppercase" id="dante-whisper">Escaneando Red...</h1>
                <div class="text-xl font-black italic">MAPA <span id="perfil-tag" style="color: var(--primary);">DANTE</span></div>
            </div>
            <div class="text-right">
                <div id="hud-itochi" class="text-lg font-black text-white italic">0 <span style="color: var(--primary);">ITO</span></div>
                <p class="text-[7px] text-zinc-600 font-bold uppercase tracking-widest">Patrimonio_Sinc</p>
            </div>
        </div>
    </header>

    <div class="map-viewport" id="scroll-engine">
        <main class="helix-scroll-area" id="helix-scene">
            
            <svg id="neural-artery-svg">
                <path id="artery-bg" class="artery-line" d="" />
                <path id="artery-active" class="artery-pulse" d="" />
            </svg>

            <div class="node-path-container">
                <div class="node-wrapper" id="wrap-oraculo">
                    <div class="quantum-node" onclick="igniteNode('oraculo')">
                        <svg class="node-rune" viewBox="0 0 100 100"><circle cx="50" cy="50" r="30" stroke-width="6"/><circle cx="50" cy="50" r="10" fill="currentColor"/></svg>
                        <div class="node-label">NODO_01<br><b>Oráculo</b></div>
                    </div>
                </div>

                <div class="node-wrapper locked" id="wrap-pulso">
                    <div class="quantum-node" onclick="igniteNode('pulso')">
                        <svg class="node-rune" viewBox="0 0 100 100"><circle cx="50" cy="50" r="30" stroke-width="4" stroke-dasharray="5 5"/><path d="M 50,20 V 80 M 20,50 H 80" stroke-width="4"/></svg>
                        <div class="node-label">NODO_02<br><b>Pulso</b></div>
                    </div>
                </div>

                <div class="node-wrapper locked" id="wrap-boveda">
                    <div class="quantum-node" onclick="igniteNode('boveda')">
                        <svg class="node-rune" viewBox="0 0 100 100"><rect x="25" y="25" width="50" height="50" stroke-width="6"/></svg>
                        <div class="node-label">NODO_03<br><b>Bóveda</b></div>
                    </div>
                </div>

                <div class="node-wrapper locked" id="wrap-proyeccion">
                    <div class="quantum-node" onclick="igniteNode('proyeccion')">
                        <svg class="node-rune" viewBox="0 0 100 100"><path d="M 20,50 L 50,20 L 80,50 L 50,80 Z" stroke-width="6"/><circle cx="50" cy="50" r="10" fill="currentColor"/></svg>
                        <div class="node-label">NODO_04<br><b>Proyección</b></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item" onclick="igniteNode('perfil')">
            <svg style="width:20px;" viewBox="0 0 100 100" stroke="currentColor" fill="none"><path d="M 30,20 C 30,50 70,50 70,80 M 70,20 C 70,50 30,50 30,80" stroke-width="10"/></svg>
            <span class="text-[7px] font-black uppercase mt-1">ADN</span>
        </div>
        
        <div id="dante-anchor" onclick="snapToActive()">
            <canvas id="mini-dante-canvas"></canvas>
        </div>
        
        <div class="nav-item" onclick="igniteNode('boveda')">
            <span id="nav-gold" class="text-[10px] font-black" style="color:var(--gold)">$0</span>
            <span class="text-[7px] font-black uppercase mt-1">ORO</span>
        </div>
    </nav>

    <script>
        let datosUsuario = JSON.parse(localStorage.getItem('govotto_user_data')) || { nivel: 1, xp: 0, perfil: "", color: "#00ffcc", nombre: "Javier" };
        let activeColor = datosUsuario.color || "#00ffcc";

        // --- MOTOR SENSORIAL (AUDIO Y VIBRACIÓN) ---
        let audioCtx, droneOsc, droneGain;
        let systemAwake = false;

        function wakeUpSystem() {
            if (systemAwake) return;
            systemAwake = true;
            
            // Iniciar Zumbido de Fondo
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            droneOsc = audioCtx.createOscillator();
            droneGain = audioCtx.createGain();
            droneOsc.connect(droneGain); droneGain.connect(audioCtx.destination);
            droneOsc.type = 'sine';
            droneOsc.frequency.setValueAtTime(50, audioCtx.currentTime); // 50Hz Sub-bass
            droneGain.gain.setValueAtTime(0, audioCtx.currentTime);
            droneGain.gain.linearRampToValueAtTime(0.05, audioCtx.currentTime + 2); // Fade in suave
            droneOsc.start();

            // Voz de Dante
            const synth = window.speechSynthesis;
            const nombre = datosUsuario.nombre ? datosUsuario.nombre.split(' ')[0] : "Usuario";
            const utter = new SpeechSynthesisUtterance(`Sistema activo, ${nombre}.`);
            utter.pitch = 0.1; utter.rate = 0.8; utter.volume = 0.5;
            synth.speak(utter);
        }

        function playNodePulse() {
            if(!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.connect(g); g.connect(audioCtx.destination);
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(300 + (datosUsuario.xp / 5), audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(20, audioCtx.currentTime + 0.5);
            g.gain.setValueAtTime(0.1, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);
            osc.start(); osc.stop(audioCtx.currentTime + 0.5);
        }

        // --- MOTORES GRÁFICOS ---
        const bgCanvas = document.getElementById('dante-fractal-bg');
        const bgCtx = bgCanvas.getContext('2d');
        const miniCanvas = document.getElementById('mini-dante-canvas');
        const miniCtx = miniCanvas.getContext('2d');
        let bgParticles = [], miniParticles = [];

        function init() {
            // Aplicar Pureza de Color
            document.documentElement.style.setProperty('--primary', activeColor);
            document.documentElement.style.setProperty('--node-shadow', `${activeColor}60`);
            document.getElementById('fx-flash').style.backgroundColor = activeColor;

            bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight;
            miniCanvas.width = 120; miniCanvas.height = 120;

            // Configurar Curva de Fibonacci para los Nodos
            document.querySelectorAll('.node-wrapper').forEach((el, i) => {
                const xOffset = Math.sin(i * 1.618) * 80;
                const zOffset = i * -150;
                el.style.transform = `translateX(${xOffset}px) translateZ(${zOffset}px)`;
            });

            actualizarNodos();
            dibujarArteria();
            aplicarMetabolismo();

            // Generar Partículas
            for(let i=0; i<80; i++) bgParticles.push({ a: Math.random()*Math.PI*2, r: Math.random()*300+50, s: Math.random()*1.5, v: 0.005 });
            for(let i=0; i<30; i++) miniParticles.push({ a: Math.random()*Math.PI*2, r: Math.random()*20+5, v: 0.06 });

            // Disipar el Flash Inicial
            setTimeout(() => { 
                document.getElementById('fx-flash').style.opacity = '0'; 
                snapToActive(); 
            }, 600);

            // Despertar el sistema al primer toque
            document.body.addEventListener('touchstart', wakeUpSystem, { once: true });
            document.body.addEventListener('click', wakeUpSystem, { once: true });

            animate();
            document.getElementById('scroll-engine').addEventListener('scroll', dibujarArteria);
        }

        function dibujarArteria() {
            const nodes = document.querySelectorAll('.quantum-node');
            let pathData = `M ${window.innerWidth/2} 0 `;
            
            nodes.forEach((node, i) => {
                const rect = node.getBoundingClientRect();
                const x = rect.left + rect.width / 2;
                const y = node.getBoundingClientRect().top + document.getElementById('scroll-engine').scrollTop + rect.height / 2;
                if (i === 0) pathData += `Q ${x} ${y/2}, ${x} ${y} `;
                else {
                    pathData += `T ${x} ${y} `;
                }
            });
            
            document.getElementById('artery-bg').setAttribute('d', pathData);
            document.getElementById('artery-active').setAttribute('d', pathData);
        }

        function snapToActive() {
            const active = document.querySelector('.node-wrapper.active') || document.querySelector('.node-wrapper.completed:last-of-type');
            if(active) {
                active.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function actualizarNodos() {
            const u = datosUsuario;
            const set = (id, state) => { document.getElementById(`wrap-${id}`).className = `node-wrapper ${state}`; };

            if(u.perfil) set('oraculo', 'completed');
            if(u.perfil && !u.ubicacion) set('pulso', 'active');
            if(u.ubicacion) { set('pulso', 'completed'); set('boveda', 'active'); }
            if(u.goldState) { set('boveda', 'completed'); set('proyeccion', 'active'); }

            document.getElementById('hud-itochi').innerHTML = `${Math.floor(u.xp / 10)} <span style="color: var(--primary);">ITO</span>`;
            document.getElementById('nav-gold').innerText = `$${(u.xp * 12).toLocaleString()}`;
        }

        function aplicarMetabolismo() {
            const el = document.getElementById('dante-whisper');
            const msgs = ["Dante siente tu pulso...", "Sincronía bio-métrica estable.", "Cosechando datos del alma."];
            el.innerText = msgs[Math.floor(Math.random()*msgs.length)];
            document.getElementById('perfil-tag').innerText = datosUsuario.perfil || "SINCRO";
        }

        function animate() {
            bgCtx.fillStyle = 'rgba(0,0,0,0.15)'; bgCtx.fillRect(0,0,bgCanvas.width, bgCanvas.height);
            bgParticles.forEach(p => {
                p.a += p.v;
                let x = bgCanvas.width/2 + Math.cos(p.a) * p.r;
                let y = bgCanvas.height/2 + Math.sin(p.a) * p.r;
                bgCtx.beginPath(); bgCtx.arc(x, y, p.s, 0, Math.PI*2);
                bgCtx.fillStyle = activeColor; bgCtx.fill();
            });

            miniCtx.clearRect(0,0,120,120);
            miniParticles.forEach(p => {
                p.a += p.v;
                let x = 60 + Math.cos(p.a) * p.r;
                let y = 60 + Math.sin(p.a) * p.r;
                miniCtx.beginPath(); miniCtx.arc(x, y, 1.5, 0, Math.PI*2);
                miniCtx.fillStyle = activeColor; miniCtx.fill();
            });
            requestAnimationFrame(animate);
        }

        function igniteNode(type) {
            wakeUpSystem(); // Asegurar que el audio está activo
            playNodePulse();
            
            // Vibración Fibonacci (13ms, 21ms)
            if(navigator.vibrate) navigator.vibrate([13, 21]); 
            
            const flash = document.getElementById('fx-flash');
            flash.style.opacity = '1';
            
            // Desvanecer el drone de audio si existe
            if(droneGain) droneGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.5);

            setTimeout(() => { window.location.href = type + '.html'; }, 600);
        }

        window.onload = init;
    </script>
</body>
</html>