<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GoVotto | LA BÓVEDA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;600;900&family=JetBrains+Mono:wght@500;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { 
            --gold: #D4AF37; 
            --primary: #00ffcc; 
            --bg: #010202; 
        }
        body { 
            background: var(--bg); color: white; margin: 0; font-family: 'Outfit', sans-serif; 
            overflow: hidden; height: 100vh; user-select: none; -webkit-tap-highlight-color: transparent;
            transition: background-color 1s ease;
        }
        
        canvas { position: fixed; inset: 0; z-index: 1; opacity: 0.6; pointer-events: none; }

        /* --- UI HUD --- */
        .hud-vault { position: relative; z-index: 100; padding: 40px; display: flex; justify-content: space-between; align-items: flex-start; pointer-events: none; }
        .vault-tag { font-family: 'JetBrains Mono'; font-size: 8px; color: var(--primary); letter-spacing: 0.5em; text-transform: uppercase; transition: color 1s; }

        /* --- EL HIPERCUBO 3D --- */
        .vault-scene { 
            position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; 
            perspective: 1200px; z-index: 50; pointer-events: none;
        }
        .hypercube {
            width: 140px; height: 140px; position: relative; transform-style: preserve-3d;
            animation: rotateCube 15s infinite linear; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .face {
            position: absolute; width: 140px; height: 140px;
            background: rgba(0, 0, 0, 0.8); border: 1px solid var(--primary);
            display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px);
            box-shadow: inset 0 0 30px rgba(0,0,0,1), 0 0 20px rgba(0,0,0,0.5);
        }
        .front  { transform: translateZ(70px); }
        .back   { transform: rotateY(180deg) translateZ(70px); }
        .right  { transform: rotateY(90deg) translateZ(70px); }
        .left   { transform: rotateY(-90deg) translateZ(70px); }
        .top    { transform: rotateX(90deg) translateZ(70px); }
        .bottom { transform: rotateX(-90deg) translateZ(70px); }

        .hypercube.unlocking { animation-duration: 1.5s; transform: scale(1.2); }
        .hypercube.unlocked .face { 
            border-color: var(--gold); background: rgba(212, 175, 55, 0.1);
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.4), inset 0 0 20px var(--gold);
        }

        @keyframes rotateCube { 
            from { transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg); }
            to { transform: rotateX(360deg) rotateY(360deg) rotateZ(360deg); }
        }

        /* --- BOTÓN DE EXTRACCIÓN (Z-INDEX 9999) --- */
        .extraction-footer {
            position: fixed; bottom: 50px; width: 100%; display: flex; flex-direction: column;
            align-items: center; z-index: 9999; padding: 0 40px; pointer-events: none;
        }
        .press-zone {
            width: 100px; height: 100px; border-radius: 50%; border: 2px solid var(--primary);
            display: flex; align-items: center; justify-content: center;
            background: rgba(0, 0, 0, 0.8); color: var(--primary);
            transition: 0.3s; pointer-events: auto; position: relative;
            box-shadow: 0 0 30px rgba(0,0,0,0.8); cursor: pointer; touch-action: none;
        }
        .press-zone.scanning { transform: scale(0.9); border-color: #fff; color: #fff; box-shadow: 0 0 50px var(--primary); }

        #extract-progress { position: absolute; width: 120px; height: 120px; pointer-events: none; transform: rotate(-90deg); }
        #progress-circle { stroke: var(--primary); stroke-dasharray: 314; stroke-dashoffset: 314; transition: stroke-dashoffset 0.1s linear; fill: none; }

        /* --- REVELACIÓN DE SALDO --- */
        #balance-reveal {
            position: fixed; inset: 0; background: radial-gradient(circle at center, rgba(30,25,5,0.98), #000);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10000; backdrop-filter: blur(30px); opacity: 0; transition: opacity 1s;
        }
        .val-cop { font-size: 4.5rem; font-weight: 900; color: var(--gold); text-shadow: 0 0 40px rgba(212, 175, 55, 0.4); }

        #gold-flash { position: fixed; inset: 0; z-index: 20000; background: #fff; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
    </style>
</head>
<body>

    <div id="gold-flash"></div>
    <canvas id="vault-canvas"></canvas>

    <div class="hud-vault" id="hud-top">
        <div>
            <p class="vault-tag" id="profile-tag">Bóveda_Encriptada</p>
            <h1 class="text-3xl font-black italic tracking-tighter text-white">EXTRACCIÓN</h1>
        </div>
        <div class="text-right">
            <p class="vault-tag">Afinidad_Mercado</p>
            <p id="market-value" class="text-xl font-bold text-white font-mono opacity-50">ESTABLE</p>
        </div>
    </div>

    <div class="vault-scene">
        <div class="hypercube" id="cube">
            <div class="face front"><i class="fas fa-lock opacity-30 text-5xl" id="lock-icon"></i></div>
            <div class="face back"></div><div class="face right"></div>
            <div class="face left"></div><div class="face top"></div>
            <div class="face bottom"></div>
        </div>
    </div>

    <div class="extraction-footer" id="footer-control">
        <p class="text-[9px] font-mono tracking-[0.4em] text-zinc-500 mb-6 uppercase" id="scan-text">Mantener para Identificar</p>
        <div class="press-zone" id="press-trigger">
            <svg id="extract-progress"><circle id="progress-circle" r="50" cx="60" cy="60" stroke-width="3"></circle></svg>
            <i class="fas fa-fingerprint text-4xl"></i>
        </div>
    </div>

    <div id="balance-reveal">
        <div class="text-center mb-10">
            <p class="font-mono text-[10px] tracking-[0.3em] text-zinc-500 uppercase">Capital Sincronizado</p>
            <h2 class="val-cop italic" id="val-cop">$0</h2>
        </div>
        <button class="px-12 py-5 bg-[#D4AF37] text-black font-black text-[11px] tracking-[0.5em] uppercase rounded-lg" onclick="finalExit()">
            Sincronizar y Volver al Mapa
        </button>
    </div>

    <script>
        let datosUsuario = JSON.parse(localStorage.getItem('govotto_user_data')) || { nivel: 1, xp: 0, perfil: "DESCONOCIDO" };
        let activeColor = datosUsuario.color || "#00ffcc";
        document.documentElement.style.setProperty('--primary', activeColor);
        document.getElementById('profile-tag').innerText = `PERFIL: ${datosUsuario.perfil}`;

        // --- MOTOR GRÁFICO ---
        const canvas = document.getElementById('vault-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [], isGolden = false;

        function init() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            for(let i=0; i<60; i++) particles.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, s: Math.random()*2, v: Math.random()*0.5 + 0.1 });
            animate();
            setupEvents();
        }

        function animate() {
            ctx.clearRect(0,0,canvas.width, canvas.height);
            particles.forEach(p => {
                p.y -= p.v; if(p.y < 0) p.y = canvas.height;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.s, 0, Math.PI*2);
                ctx.fillStyle = isGolden ? "#D4AF37" : activeColor;
                ctx.fill();
            });
            requestAnimationFrame(animate);
        }

        // --- LÓGICA DE EXTRACCIÓN ---
        let audioCtx, scanOsc, holdTimer, progress = 0;

        function setupEvents() {
            const btn = document.getElementById('press-trigger');
            const start = (e) => { e.preventDefault(); startExtraction(); };
            const end = () => stopExtraction();

            btn.addEventListener('mousedown', start);
            btn.addEventListener('touchstart', start);
            window.addEventListener('mouseup', end);
            window.addEventListener('touchend', end);
        }

        function startExtraction() {
            if (progress >= 100) return;
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if(audioCtx.state === 'suspended') audioCtx.resume();

            scanOsc = audioCtx.createOscillator();
            let gain = audioCtx.createGain();
            scanOsc.connect(gain); gain.connect(audioCtx.destination);
            scanOsc.type = 'sawtooth'; scanOsc.frequency.value = 100;
            scanOsc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 3);
            gain.gain.value = 0.1; scanOsc.start();

            document.getElementById('press-trigger').classList.add('scanning');
            document.getElementById('cube').classList.add('unlocking');
            document.getElementById('scan-text').innerText = "IDENTIFICANDO ADN...";

            holdTimer = setInterval(() => {
                progress += 1.5;
                document.getElementById('progress-circle').style.strokeDashoffset = 314 - (progress/100*314);
                if(navigator.vibrate) navigator.vibrate(10);
                if(progress >= 100) { clearInterval(holdTimer); triggerSuccess(); }
            }, 40);
        }

        function stopExtraction() {
            if(progress >= 100) return;
            clearInterval(holdTimer); progress = 0;
            if(scanOsc) { scanOsc.stop(); scanOsc = null; }
            document.getElementById('press-trigger').classList.remove('scanning');
            document.getElementById('cube').classList.remove('unlocking');
            document.getElementById('progress-circle').style.strokeDashoffset = 314;
            document.getElementById('scan-text').innerText = "MANTENER PARA IDENTIFICAR";
        }

        function triggerSuccess() {
            if(scanOsc) scanOsc.stop();
            isGolden = true;
            document.getElementById('gold-flash').style.opacity = '1';
            document.getElementById('cube').classList.add('unlocked');
            document.getElementById('lock-icon').className = "fas fa-check-circle text-gold";
            
            setTimeout(() => {
                document.getElementById('gold-flash').style.opacity = '0';
                revealData();
            }, 300);
        }

        function revealData() {
            document.getElementById('hud-top').style.opacity = '0';
            document.getElementById('footer-control').style.opacity = '0';
            document.getElementById('val-cop').innerText = `$${(datosUsuario.xp * 12).toLocaleString()}`;
            const rev = document.getElementById('balance-reveal');
            rev.style.display = 'flex'; setTimeout(() => rev.style.opacity = '1', 100);
        }

        function finalExit() {
            datosUsuario.goldState = true;
            localStorage.setItem('govotto_user_data', JSON.stringify(datosUsuario));
            window.location.href = 'mapa.html?skipIntro=true';
        }

        window.onload = init;
    </script>
</body>
</html>